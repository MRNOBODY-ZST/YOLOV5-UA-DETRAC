**基于YOLOV5的智能红绿灯解决方案**

1. **摘要**

**（一）研究背景**

上世纪 80 年代改革开放以来，我国的市场经济与科技面貌发生了翻天覆地的变化， 大量的科学技术应用到了人们的日常生活，改变着人们的传统生活模式。汽车作为一种大规模普及的运输工具，已经变成多数人工作和生活中不可或缺的一部分。据统计，2010年以来，我国机动车保有量以每年超过 1500万辆的速度快速增长。但是，我国大部分地区的交通基础设施建设不够完善，亟待加强，同时现有的交通基础设施利用效率低下，致使机动车在为国民经济发展做出巨大贡献的同时也带来如城市交通拥堵、交通事故频发等大量挑战。为了解决这些问题，我国很多一线城市都出台了大量政策措施，如 2010年12月23日，北京针对机动车数量过快增长，正式实施“限购令”。2012年6月30日，广州出台相似限购措施，对机动车进行配额管理。同时，很多城市都在研究制订各类方案治理交通拥堵。然而靠政策制度和简单限购并不能很好的应对现代社会车辆快速增长所带来的问题，传统的交通技术和手段已不适应经济社会发展的要求，这就促使了一个新的研究领域—智能交通系统的兴起。智能交通系统[1]是交通系统公认的发展方向，它是在地面交通管理系统的平台上，集成通讯技术、传感检测技术、控制技术和计算机技术于一体，且覆盖范围广、实时、高效的一种综合交通管理系统。ITS通过利用现有交通设施，对现行的一部分交通管理方法进行改进，从而减小交通压力、减小交通管理成本、提高交通系统利用效率，因而越来越被城市管理者所重视、成为现代城市文明发展的重要标志。目前，常见的智能交通系统一般由以下几种子系统协调配合而成。 

1) 自动收费系统

电子不停车收费系统（ETC）是目前大面积推广的自动收费系统，是智能交通系统的主要组成部分。ETC 对无线电射频识别及计算机等相关技术系统集成，实现对车辆的 识别、自动计费、车道设备控制和收费数据处理等功能[2]。与人工收费系统的区别在于， ETC 技术通过车载电子标签与自动收费车道上专用短程通讯，读取电子标签中存放的车 辆固有信息（如车辆类别、车牌等）和征费状态等相关信息；按照预先设定的收费标准， 通过计算，自动进行结算处理，从而过往车辆通过道口时无须停车，即能够实现不停车自动收费，可以大幅提升车道的通行能力。 

(2)交通监控系统交通

监控系统是智能交通系统的一个重要组成部分，该系统通过检测和控制等系统模块来反馈和控制交通状态, 提高交通运输过程的安全度和舒适度。常见的交通监控系统主要是基于超声波检测技术、视频图像检测技术等来实现道路交通信息的采集；及时准确地将所掌握的道路交通流量、交通治安情况等信息，通过光纤、电话线和微波等传输手段提供给驾驶员和交通管理人员，为智能交通系统对交通流的控制提供决策依据。同时，交通监控系统通过对车辆的运动轨迹、速度进行检测[3]，可记录监控范围内的车辆违规行为，对车辆违规行为进行视频取证。 

(3)智能汽车控制系统

智能汽车控制系统是指辅助驾驶员驾驶汽车或替代驾驶员自动驾驶汽车的系统[4]，该系统理论上能实现自动驾驶、自动变速和自动识别道路等功能。该系统可通过内置的定位和导航系统，控制车辆按预置路线行驶；通过结合车身安装的雷达或红外探测仪，可以准确地判断路况和障碍，使得即便在很复杂的道路情况下，系统也能根据路况调节行车速度并能自动操控车辆绕开障碍物。 

(4)智能交通灯控制系统 

智能交通灯控制系统是指利用智能控制方式代替传统人工控制或固时控制方式的交通灯控制系统。一般利用采集到的某交叉口或某区域内的实时交通信息，通过预置的交通灯配时算法智能调节交通灯各方向分配的绿灯时间，从而达到可根据实时的交通情况进行自适应调整的目的。该系统通常通过预设的车辆检测装置，如感应线圈、红外检测器等，来获得实时车流情况。随着交通监控系统的发展，现在，智能交通灯控制系统也可以通过已有的交通监控系统采集实时交通信息。智能交通灯控制系统的应用能更好 地利用现有的道路运输能力，改善交通状况，缓解交通压力，使得交通运输更加安全、 舒适和高效。 作为现代城市智能交通系统的重要组成部分，虽然智能交通灯难以独自解决城市交通存在的问题[5]，但它能与智能交通系统的其他部分紧密配合，在调节交通流、提高道路利用率、改善交通拥堵等方面发挥重要作用。这也是智能交通灯成为当前应用最广泛的交通控制方式之一的重要原因。 

**（二）研究目的**

减少堵车发生的可能性，增加交通流畅度。

**（三）研究方法**

实验法、问卷研究法、案例法

4. **小组成员**
**
` `张深态，沈正炀，叶君琳，吴熙鸣，陶炳州，钟世展

1. **研究过程**

**（一）问卷调查**

我们首先对于上海市堵车情况准备一份调查问卷，设计了一些重点问题，选择上海市学生与上班族作为我们的受众，一共有265人填写了问卷，得到的调查结果如下：

![Aspose.Words.e798491e-6804-4385-b218-7a84c3ba85e8.001.png](https://s2.loli.net/2022/01/02/vLMFBcr4DXhKfzR.png)



​                                                  「上海市上班族、学生遇到拥堵状况几率」

` `![Aspose.Words.e798491e-6804-4385-b218-7a84c3ba85e8.002.png](https://s2.loli.net/2022/01/02/nkCBUdgEmlvsaAt.png)



​                                                    「上海市上班族、学生遇堵车平均时长」

从上面两幅图我们不难看出，上班族与学生群体遇到拥堵状况的机率集中在30%至50%之间，平均堵车机率为44.517%，堵车平均时长在10分钟至40分钟区间内，平均拥堵时长为22.875分钟。

我们还获取对于改进堵车的意见，并筛选了有价值的建议，在此展现出来：

「限制车辆使用，淘汰过老车型，多建造高架，纵向发展道路」

「错峰出行，使用公共交通工具，提早学生放学时间以避开工作晚高峰」

「红绿灯转换算法优化，交警现场秩序维护」

2. **堵车原因分析**

如今利用私家车通勤的人们在遇到堵车时往往将原因归结为如今私家车数量的激增。但是也并不是在许多人口密集，交通发达的大城市中都出现了如此现象。通过案例的分析以及查阅资料。我们的分析为：导致堵车的真凶并不仅仅是车多，而是由于红绿灯的时间控制不合理而导致的行驶过程中的不协调。一个红绿灯时间控制出现了问题会限制每一次通过一个路口的车的数量，直接导致其他相关的路口也发生拥堵现象，这样城市的堵塞积累就永远解决不了。虽然大型高速公路中不设十字路口与红绿灯，理论上可以避免堵车。但为什么特别是节假日高速公路也同样车满为患，排起长龙呢?第一个原因是高速上有上下匝道口，在车辆汇入时为了谨防与直道上飞驰的汽车相撞而小心翼翼的找最合适的时机加入车群中容易造成拥堵。第二个原因就是“幽灵堵车”。假设在高速上接近限速的车群中有一辆车突然变道，那么后车为了安全起见必然会踩下刹车，紧随其后的车辆看到前车停滞也会一辆接一辆的踩下刹车就等于人为制造了一个隐形的闹市区十字路口。最终这场”幽灵堵车”事件引发一场交通海啸。

**（三）程序设计**

由于涉及图像识别算法，我们这次使用YOLO V5（You Only Look Once）来作为我们的图像识别框架。YOLO V5是目前准确度与检测速度最高的图像识别算法。同时，YOLO V5基于PyTorch框架，能够在日后很方便的移植到各种边缘化设备中（开发板，微型计算机，终端设备）。关于YOLO V5的算法原理，请参照原作者论文《You Only Look Once: Unified, Real-Time Object Detection》[6]。

YOLO V5有不同版本的预训练模型，分别是Nano版本，Small版本，Medium版本，Large版本与Extreme版本，各个版本的检测准确度与检测速度都不相同，大致如下：

![Aspose.Words.e798491e-6804-4385-b218-7a84c3ba85e8.003.png](https://s2.loli.net/2022/01/02/JsGlqSN45wfbWtv.png)

「YOLO V5预训练模型准确度、速度比较」

基于检测速度与检测准确度的考虑，我们选择了各项指标都很突出的YOLO V5L6模型作为我们的预训练模型，并使用UA-DETRAC车辆数据集进行训练。UA-DETRAC数据集是车辆检测和跟踪的大规模数据集，数据集主要拍摄于北京和天津的道路过街天桥（京津冀场景），并手动标注了 8250 个车辆 和 121万目标对象外框，共82050张图片。车辆分为四类，即轿车、公共汽车、厢式货车和其他车辆。天气情况分为四类，即多云、夜间、晴天和雨天。我们训练使用90%的照片作为训练集，10%的照片作为验证集，训练200回合。

训练时模型收敛速度非常快，在第20个回合的时候就BOX\_LOSS就已经收敛到了0.0161，CLASS\_LOSS收敛到了9.28 E-4，准确度则为98.47%。在第200回合时，BOX\_LOSS收敛到了0.01281，CLASS\_LOSS收敛到了6.0252 E-4的级别，而准确度则是达到了99.22%。

![Aspose.Words.e798491e-6804-4385-b218-7a84c3ba85e8.004.jpeg](https://s2.loli.net/2022/01/02/utflDkAdWiUaRje.jpg)

「训练识别效果」

在训练完成后就是程序的设计与编写。程序分为三个模块，分别是摄像头检测模块，中央决策服务器模块，红绿灯控制模块。

摄像头检测模块负责检测摄像头中可见的车辆数目，并用TCP协议传输回决策服务器，检测模块使用YOLO V5图像识别框架，对于1080P的视频流，可以在Nvidia的Jetson开发板上以下采样到320P时做到20FPS的检测速度，原数据流可以做到5FPS的检测速度。对于单次车辆识别利用高效检测速度可以多帧取品均值，增加检测的准确性。

伪代码如下：

1. 连接到决策服务器TCP端口，无法连接时终止程序
1. 连接上后运行YOLO V5检测框架，目标源获取为本地摄像头
1. 监测数据一次处理
1. TCP协议发送至决策服务器

中央决策服务器从4摄像头检测模块获取车辆数量，并判断车辆数量。

![Aspose.Words.e798491e-6804-4385-b218-7a84c3ba85e8.005.png](https://s2.loli.net/2022/01/02/nW7g8zilGkJI5MR.png)

「各十字路口摄像头」

总体决策逻辑为：当摄像头1+摄像头2中的车辆数与摄像头3+摄像头4中的车辆数都小于10，或车辆数之差小于5时执行均等时间程序。当摄像头1+2或摄像头3+4中的车辆数大于10 或之差大于5的时候，执行梯度时间程序。具体梯度为：当横纵车辆数之差大于5时，车辆数多的一边红绿灯时间权重为60%，而另一边则为40%，红绿灯总时间固定，单边红灯时间为：

车辆多：红绿灯总时间\*（权重+50%）\*（车辆数）/总车辆数=红灯时间

车辆少：红绿灯总时间\*（权重+50%）\*（车辆数）/总车辆数=红灯时间

当两边车辆之差大于10时，权重变为65%/35%，以此类推，车辆之差每增加5辆，最大权重增大5%。权重最大为75%。在得到红灯时间后，把红灯时间利用TCP协议传输给红绿灯控制模块并打上时间戳。

红绿灯控制模块在接收到红灯时间后控制红绿灯。绿灯时间为红灯时间-3秒，黄灯时间为3秒。

伪代码如下：

1. 从检测模块获取车辆数据
1. 监测数据求和算差，比例
1. 进行判断，判断进入循环条件是否满足
1. 根据循环内条件计算时间
1. 得到时间后利用TCP协议发送给控制模块
1. 再次循环

在控制的同时把控制信息返还给中央决策服务器，打上时间戳，中央决策服务器把返还信息储存到数据库中，方便监管，调试，同时在收到控制信息后进行下一轮检测。

总流程图如下：

![Aspose.Words.e798491e-6804-4385-b218-7a84c3ba85e8.006.png](https://s2.loli.net/2022/01/02/L2d5HwMr3TNpAuR.png)

1. **结论与成果**

上图检测是在960P，下采样至640P后检测的，前景车辆识别率100%，中远景车辆识别率50%，单图识别所花费时间在0.2S~0.5S不等。

中央决策服务器运行图片：

![](Aspose.Words.e798491e-6804-4385-b218-7a84c3ba85e8.007.png)

「Mainserver 数据输出」

得到的数据格式为：纵向车流量；横向车流量；纵向红灯时间；横向红灯时间。

在得到控制模型之后，我们使用SUMO进行仿真实验，路网模型使用上海市莘庄镇西环路口作为验证路网。

![Aspose.Words.e798491e-6804-4385-b218-7a84c3ba85e8.008.png](https://s2.loli.net/2022/01/02/sZKqBVDIwNRWfQ2.png)

「西环路路口」

此路口在每日下午5:30分至下午7:30分都会有十分严重的堵车现象，我们在2021年11月26日星期五下午对路口的车流量进行了监控，搭建了模型，计算出平均车流量。

随后我们套用上我们的控制模型，结果如下：

![Aspose.Words.e798491e-6804-4385-b218-7a84c3ba85e8.009.png](https://s2.loli.net/2022/01/02/1ud8vL2RfXyCjTe.png)

改进后的模型在道路通畅度上有了97%的提高，对于西环路口的车流量能较好的控制。

1. **反思**

这次我们的控制模型与识别系统还只是停留在初始阶段，模型较为粗糙，只是简单的表现出了自己的想法，实验虽然得出了成功的效果，但是实验方法与内容不够完善，对于人工智能的训练也只停留在最初始的“能用”阶段，准确度。灵活性还有待提高。此外，我发现模型好像出现了过拟合现象，使得识别普遍性有所下降。同时，我们的组内合作效率还有待提高，这次没有能很好的一起合作。

1. **参考文献**
1. 王国锋 宋鹏飞 张蕴灵. 智能交通系统发展与展望[J].公路，2012,5(5):217-222.
1. 张宇欢.我国 ETC 系统的应用[J]. 中国新技术新产品,2010,(19):22-23
1. 王 为 , 姚明海 . 基 于 计 算 机 视 觉 的 智 能 交 通 监 控 系 统 [J]. 浙 江 工 业 大 学 学 报,2010,38(5):574-579
1. 徐中明,陈旭,贺岩松,等.智能交通系统(ITS)中的智能汽车技术[J]. 重庆大学学报( 自 然科学版),2005,28(8):17-21
1. 黄辉先. 城市交通信号优化控制方法的研究[D]:[西北工业大学博士学位论文].西安： 西北工业大学控制理论与控制工程专业，2000,3-6.
1. Redmon J ,  Divvala S ,  Girshick R , et al. You Only Look Once: Unified, Real-Time Object Detection[J]. Computer Vision & Pattern Recognition, 2016.
